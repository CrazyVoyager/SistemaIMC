@* Ubicación: SistemaIMC/Views/Home/Index.cshtml *@
@model SistemaIMC.Models.ViewModels.DashboardViewModel

@{
    ViewData["Title"] = "Página Principal";

    // Definición de variable de permisos de alto nivel:
    // SOLO el rol "Administrador del Sistema" verá las tarjetas de Administración y Configuración.
    bool esAdministrador = User.IsInRole("Administrador del Sistema");
    string nombreUsuario = User.Identity?.Name ?? "Usuario";
}

<div class="welcome-card shadow mb-4">
    <div class="card-body p-4 p-md-5">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-5 fw-bold mb-3">
                    <i class="fas fa-heartbeat me-2"></i>¡Bienvenido al IMCinador, @nombreUsuario!
                </h1>
                <p class="fs-5 mb-0" style="color: rgba(255,255,255,0.9);">
                    ¡Esta es tu plataforma IMCinador para la gestión y seguimiento nutricional de los estudiantes! 
                    Desde aquí puede acceder a los principales módulos del sistema.
                </p>
                <hr class="my-4" style="border-color: rgba(255,255,255,0.3);">
                <p class="mb-0" style="color: rgba(255,255,255,0.8);">
                    <i class="fas fa-info-circle me-2"></i>
                    Utilice el menú lateral ( <i class="fas fa-bars"></i> ) para navegar por todas las opciones.
                </p>
            </div>
            <div class="col-lg-4 text-center d-none d-lg-block">
                <i class="fas fa-chart-line" style="font-size: 8rem; opacity: 0.3;"></i>
            </div>
        </div>
    </div>
</div>

@* Tarjetas de Estadísticas Rápidas *@
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2 stat-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs fw-bold text-primary text-uppercase mb-1">Total Estudiantes</div>
                        <div class="h5 mb-0 fw-bold text-gray-800 counter" data-target="@Model.TotalEstudiantes">@Model.TotalEstudiantes</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2 stat-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs fw-bold text-success text-uppercase mb-1">Total Mediciones</div>
                        <div class="h5 mb-0 fw-bold text-gray-800 counter" data-target="@Model.TotalMediciones">@Model.TotalMediciones</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-weight fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2 stat-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs fw-bold text-info text-uppercase mb-1">Mediciones Este Mes</div>
                        <div class="h5 mb-0 fw-bold text-gray-800 counter" data-target="@Model.MedicionesEsteMes">@Model.MedicionesEsteMes</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-check fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2 stat-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs fw-bold text-warning text-uppercase mb-1">Establecimientos</div>
                        <div class="h5 mb-0 fw-bold text-gray-800 counter" data-target="@Model.TotalEstablecimientos">@Model.TotalEstablecimientos</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-school fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Gráficos Principales *@
<div class="row">
    @* Gráfico de Distribución IMC *@
    <div class="col-xl-6 col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 fw-bold text-primary">
                    <i class="fas fa-chart-pie me-2"></i>Distribución por Categoría IMC
                </h6>
            </div>
            <div class="card-body">
                @if (Model.DistribucionIMC.Any())
                {
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="chartDistribucionIMC"></canvas>
                    </div>
                }
                else
                {
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-chart-pie fa-3x mb-3"></i>
                        <p>No hay datos de mediciones disponibles</p>
                    </div>
                }
            </div>
        </div>
    </div>

    @* Gráfico de Estudiantes por Sexo *@
    <div class="col-xl-6 col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 fw-bold text-primary">
                    <i class="fas fa-venus-mars me-2"></i>Distribución por Sexo
                </h6>
            </div>
            <div class="card-body">
                @if (Model.EstudiantesMasculino > 0 || Model.EstudiantesFemenino > 0)
                {
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="chartSexo"></canvas>
                    </div>
                }
                else
                {
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-venus-mars fa-3x mb-3"></i>
                        <p>No hay estudiantes registrados</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="row">
    @* Gráfico de Mediciones por Mes *@
    <div class="col-xl-8 col-lg-7 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3">
                <h6 class="m-0 fw-bold text-primary">
                    <i class="fas fa-chart-line me-2"></i>Mediciones por Mes (Últimos 6 meses)
                </h6>
            </div>
            <div class="card-body">
                @if (Model.MedicionesMensuales.Any())
                {
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="chartMedicionesMes"></canvas>
                    </div>
                }
                else
                {
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <p>No hay mediciones en los últimos 6 meses</p>
                    </div>
                }
            </div>
        </div>
    </div>

    @* Panel de Acciones Rápidas *@
    <div class="col-xl-4 col-lg-5 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3">
                <h6 class="m-0 fw-bold text-primary">
                    <i class="fas fa-bolt me-2"></i>Acciones Rápidas
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-3">
                    <a asp-controller="T_Estudiante" asp-action="Create" class="btn btn-primary btn-lg">
                        <i class="fas fa-user-plus me-2"></i>Nuevo Estudiante
                    </a>
                    <a asp-controller="T_MedicionNutricional" asp-action="Create" class="btn btn-success btn-lg">
                        <i class="fas fa-plus-circle me-2"></i>Nueva Medición
                    </a>
                    <a asp-controller="T_Estudiante" asp-action="Index" class="btn btn-info btn-lg">
                        <i class="fas fa-search me-2"></i>Buscar Estudiante
                    </a>
                    <a asp-controller="T_MedicionNutricional" asp-action="Index" class="btn btn-warning btn-lg">
                        <i class="fas fa-list-alt me-2"></i>Ver Mediciones
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@* Top Establecimientos - Solo para Admin *@
@if (esAdministrador && Model.TopEstablecimientos.Any())
{
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 fw-bold text-primary">
                        <i class="fas fa-trophy me-2"></i>Top 5 Establecimientos con Más Mediciones
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="chartTopEstablecimientos"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@* Tarjetas de Módulos *@
<div class="row">
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card dashboard-card shadow h-100">
            <div class="card-body d-flex flex-column p-4">
                <div class="icon-wrapper icon-primary mb-3">
                    <i class="fas fa-user-graduate fa-lg"></i>
                </div>
                <h5 class="card-title fw-bold">Gestión Nutricional</h5>
                <p class="card-text text-muted flex-grow-1">
                    Administre estudiantes y registre las mediciones nutricionales para el seguimiento de la población estudiantil.
                </p>
                <div class="d-flex flex-wrap gap-2 mt-3">
                    <a asp-controller="T_Estudiante" asp-action="Index" class="btn btn-primary">
                        <i class="fas fa-users me-1"></i> Estudiantes
                    </a>
                    <a asp-controller="T_MedicionNutricional" asp-action="Index" class="btn btn-info">
                        <i class="fas fa-weight me-1"></i> Mediciones
                    </a>
                </div>
            </div>
        </div>
    </div>

    @* INICIO DE BLOQUE RESTRINGIDO: SOLO VISIBLE PARA EL ROL "Administrador del Sistema" *@
    @if (esAdministrador)
    {
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card dashboard-card shadow h-100" style="--card-accent: #11998e;">
                <div class="card-body d-flex flex-column p-4">
                    <div class="icon-wrapper icon-success mb-3">
                        <i class="fas fa-users-cog fa-lg"></i>
                    </div>
                    <h5 class="card-title fw-bold">Administración</h5>
                    <p class="card-text text-muted flex-grow-1">
                        Gestione las cuentas de usuario (docentes, administradores) y sus respectivos roles en el sistema.
                    </p>
                    <div class="d-flex flex-wrap gap-2 mt-3">
                        <a asp-controller="T_Usuario" asp-action="Index" class="btn btn-success">
                            <i class="fas fa-user-shield me-1"></i> Usuarios
                        </a>
                        <a asp-controller="T_Rol" asp-action="Index" class="btn btn-secondary">
                            <i class="fas fa-key me-1"></i> Roles
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card dashboard-card shadow h-100" style="--card-accent: #f5af19;">
                <div class="card-body d-flex flex-column p-4">
                    <div class="icon-wrapper icon-warning mb-3">
                        <i class="fas fa-cogs fa-lg"></i>
                    </div>
                    <h5 class="card-title fw-bold">Configuración</h5>
                    <p class="card-text text-muted flex-grow-1">
                        Configure las tablas base del sistema: establecimientos, cursos, regiones, comunas y categorías de IMC.
                    </p>
                    <div class="d-flex flex-wrap gap-2 mt-3">
                        <a asp-controller="T_Establecimiento" asp-action="Index" class="btn btn-warning">
                            <i class="fas fa-school me-1"></i> Configurar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
    @* FIN DE BLOQUE RESTRINGIDO *@
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Detectar tema oscuro
            const isDarkMode = () => document.documentElement.getAttribute('data-bs-theme') === 'dark';
            
            // Colores adaptables al tema
            const getTextColor = () => isDarkMode() ? '#e4e6eb' : '#5a5c69';
            const getGridColor = () => isDarkMode() ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';

            // Opciones comunes para los gráficos
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: getTextColor()
                        }
                    }
                }
            };

            // 1. Gráfico de Distribución IMC (Doughnut)
            @if (Model.DistribucionIMC.Any())
            {
                <text>
                const ctxIMC = document.getElementById('chartDistribucionIMC');
                if (ctxIMC) {
                    new Chart(ctxIMC, {
                        type: 'doughnut',
                        data: {
                            labels: [@Html.Raw(string.Join(",", Model.DistribucionIMC.Select(c => $"'{c.Categoria}'")))],
                            datasets: [{
                                data: [@string.Join(",", Model.DistribucionIMC.Select(c => c.Cantidad))],
                                backgroundColor: [@Html.Raw(string.Join(",", Model.DistribucionIMC.Select(c => $"'{c.Color}'")))],
                                borderWidth: 2,
                                borderColor: isDarkMode() ? '#1f2940' : '#fff'
                            }]
                        },
                        options: {
                            ...commonOptions,
                            cutout: '60%',
                            plugins: {
                                ...commonOptions.plugins,
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: getTextColor(),
                                        padding: 15,
                                        usePointStyle: true
                                    }
                                }
                            }
                        }
                    });
                }
                </text>
            }

            // 2. Gráfico de Estudiantes por Sexo (Pie)
            @if (Model.EstudiantesMasculino > 0 || Model.EstudiantesFemenino > 0)
            {
                <text>
                const ctxSexo = document.getElementById('chartSexo');
                if (ctxSexo) {
                    new Chart(ctxSexo, {
                        type: 'pie',
                        data: {
                            labels: ['Masculino', 'Femenino'],
                            datasets: [{
                                data: [@Model.EstudiantesMasculino, @Model.EstudiantesFemenino],
                                backgroundColor: ['#4e73df', '#e74a8a'],
                                borderWidth: 2,
                                borderColor: isDarkMode() ? '#1f2940' : '#fff'
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: {
                                ...commonOptions.plugins,
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: getTextColor(),
                                        padding: 15,
                                        usePointStyle: true
                                    }
                                }
                            }
                        }
                    });
                }
                </text>
            }

            // 3. Gráfico de Mediciones por Mes (Line)
            @if (Model.MedicionesMensuales.Any())
            {
                <text>
                const ctxMes = document.getElementById('chartMedicionesMes');
                if (ctxMes) {
                    const gradient = ctxMes.getContext('2d').createLinearGradient(0, 0, 0, 300);
                    gradient.addColorStop(0, 'rgba(102, 126, 234, 0.4)');
                    gradient.addColorStop(1, 'rgba(102, 126, 234, 0)');

                    new Chart(ctxMes, {
                        type: 'line',
                        data: {
                            labels: [@Html.Raw(string.Join(",", Model.MedicionesMensuales.Select(m => $"'{m.Mes}'")))],
                            datasets: [{
                                label: 'Mediciones',
                                data: [@string.Join(",", Model.MedicionesMensuales.Select(m => m.Cantidad))],
                                borderColor: '#667eea',
                                backgroundColor: gradient,
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: '#667eea',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 5,
                                pointHoverRadius: 7
                            }]
                        },
                        options: {
                            ...commonOptions,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: getTextColor(),
                                        stepSize: 1
                                    },
                                    grid: {
                                        color: getGridColor()
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: getTextColor()
                                    },
                                    grid: {
                                        color: getGridColor()
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
                </text>
            }

            // 4. Gráfico de Top Establecimientos (Bar)
            @if (esAdministrador && Model.TopEstablecimientos.Any())
            {
                <text>
                const ctxTop = document.getElementById('chartTopEstablecimientos');
                if (ctxTop) {
                    new Chart(ctxTop, {
                        type: 'bar',
                        data: {
                            labels: [@Html.Raw(string.Join(",", Model.TopEstablecimientos.Select(e => $"'{(e.Nombre.Length > 25 ? e.Nombre.Substring(0, 25) + "..." : e.Nombre)}'")))],
                            datasets: [{
                                label: 'Mediciones',
                                data: [@string.Join(",", Model.TopEstablecimientos.Select(e => e.CantidadMediciones))],
                                backgroundColor: [
                                    'rgba(102, 126, 234, 0.8)',
                                    'rgba(17, 153, 142, 0.8)',
                                    'rgba(245, 175, 25, 0.8)',
                                    'rgba(255, 65, 108, 0.8)',
                                    'rgba(79, 172, 254, 0.8)'
                                ],
                                borderColor: [
                                    '#667eea',
                                    '#11998e',
                                    '#f5af19',
                                    '#ff416c',
                                    '#4facfe'
                                ],
                                borderWidth: 2,
                                borderRadius: 8
                            }]
                        },
                        options: {
                            ...commonOptions,
                            indexAxis: 'y',
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: getTextColor(),
                                        stepSize: 1
                                    },
                                    grid: {
                                        color: getGridColor()
                                    }
                                },
                                y: {
                                    ticks: {
                                        color: getTextColor()
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
                </text>
            }

            // Animación de contadores
            const counters = document.querySelectorAll('.counter');
            counters.forEach(counter => {
                const target = parseInt(counter.getAttribute('data-target'));
                const duration = 1500;
                const step = target / (duration / 16);
                let current = 0;
                
                const updateCounter = () => {
                    current += step;
                    if (current < target) {
                        counter.textContent = Math.ceil(current).toLocaleString('es-CL');
                        requestAnimationFrame(updateCounter);
                    } else {
                        counter.textContent = target.toLocaleString('es-CL');
                    }
                };
                
                updateCounter();
            });
        });
    </script>
}